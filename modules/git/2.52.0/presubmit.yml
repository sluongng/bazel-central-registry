bcr_test_module:
  module_path: .
  matrix:
    platform:
      - debian11
      - ubuntu2204
    bazel:
      - 8.x
      - 7.x
  tasks:
    run_tests_linux:
      name: Test all the things
      platform: ${{ platform }}
      bazel: ${{ bazel }}
      shell_commands:
        # bcr_presubmit.py does not respect executable bit
        - chmod +x t/bazel-test-wrapper.sh
      test_flags:
        - --incompatible_strict_action_env
        - --@curl//:ssl_lib=openssl
      test_targets:
        - //...
    run_tests_macos:
      name: Test all the things (macos)
      platform: macos_arm64
      bazel: ${{ bazel }}
      shell_commands:
        # bcr_presubmit.py does not respect executable bit
        - chmod +x t/bazel-test-wrapper.sh
      test_flags:
        - --incompatible_strict_action_env
        - --@curl//:ssl_lib=openssl
        - --test_env=PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/usr/local/sbin
      test_targets:
        - //...
        # Issue with bad lib iconv on MacOS
        # Fix should be available in the next version of Git
        #   https://lore.kernel.org/git/20260111195149.716177-1-tboegi@web.de/
        #   https://lore.kernel.org/git/20260111195151.716191-1-tboegi@web.de/
        - -//t:t3900-i18n-commit
